%%{init: {
  'theme': 'base',
  'themeVariables': {
    'background': '#FFFAEE',
    'mainBkg': '#FFFAEE',
    'primaryColor': '#D7CCC8',
    'primaryTextColor': '#3E2723',
    'primaryBorderColor': '#5D4037',
    'lineColor': '#8D6E63',
    'secondaryColor': '#F5F5F5',
    'tertiaryColor': '#EFEBE9',
    'noteBkgColor': '#FFF8E1',
    'noteTextColor': '#3E2723',
    'actorBkg': '#EFEBE9',
    'actorBorder': '#8D6E63',
    'actorTextColor': '#3E2723'
  }
}}%%
sequenceDiagram
    autonumber

    participant User
    participant Client as Clients<br/>(Ext/MCP/File)
    participant Server as FastAPI Server
    participant Gate as Gatekeeper Agent
    participant Gemini as Google Gemini
    participant Chroma as ChromaDB

    Note over User, Client: [ Sources ]
    Note over Server, Gate: [ Backend System ]
    Note over Gemini, Chroma: [ External & Storage ]

    Note over User, Chroma: Phase 1: Memory Ingestion (Save)

    User->>Client: Chat / Browse / Edit File
    Client->>Server: POST /memory (Raw Content)
    activate Server
    Server->>Gate: Delegate Processing
    activate Gate
    
    Gate->>Gemini: Analyze Intent & Clean Data
    activate Gemini
    Gemini-->>Gate: Structured Memory (JSON)
    deactivate Gemini
    
    alt is_valid_memory
        Gate->>Chroma: Save Vector & Metadata
        activate Chroma
        Chroma-->>Gate: Success
        deactivate Chroma
        Gate-->>Server: Saved (Memory ID)
    else is_noise
        Gate-->>Server: Ignored (Reason)
    end
    deactivate Gate

    Server-->>Client: Status Update (Green/Gray)
    deactivate Server

    Note over User, Chroma: Phase 2: Context Retrieval (RAG)

    User->>Client: Typing Query...
    Client->>Server: Search Memory (Query)
    activate Server
    Server->>Chroma: Query Embeddings (Top-K)
    activate Chroma
    Chroma-->>Server: Relevant Memories
    deactivate Chroma
    Server-->>Client: Context Injection
    deactivate Server
    Client-->>User: AI Response + Memory Context