%%{init: {'theme': 'base', 'flowchart': {'curve': 'stepAfter'}}}%%
graph LR
    %% 样式定义
    classDef userNode fill:#FFAB91,stroke:#BF360C,stroke-width:2px,color:black,font-weight:bold;
    classDef clientNode fill:#E1F5FE,stroke:#0277BD,stroke-width:1px;
    classDef serverNode fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px,font-weight:bold;
    classDef resourceNode fill:#FFF9C4,stroke:#FBC02D,stroke-width:1px;
    classDef dbNode fill:#E1BEE7,stroke:#4A148C,stroke-width:1px;

    %% 节点
    User((User)):::userNode

    subgraph Clients ["Clients (Request Sources)"]
        direction TB
        Ext[Chrome Extension]:::clientNode
        MCP[MCP Server]:::clientNode
        CLI[CLI / Claude]:::clientNode
    end

    subgraph Backend ["Backend Service (Python)"]
        direction TB
        FastAPI[FastAPI Server<br/>main.py]:::serverNode
    end

    subgraph Resources ["Local Resources"]
        direction TB
        Youtu[Youtu-LLM<br/>via llama.cpp]:::resourceNode
        Chroma[(ChromaDB)]:::dbNode
    end

    subgraph Cloud ["Cloud"]
        CloudLLM[Gemini / Claude Web]:::resourceNode
    end

    %% 连接 - 使用直线/折线逻辑
    User --> Ext
    User --> CLI
    CLI --> MCP
    
    Ext -- "HTTP" --> FastAPI
    MCP -- "HTTP" --> FastAPI
    
    FastAPI -- "1. Store/Retrieve" --> Chroma
    FastAPI -- "2. Clean/Rerank" --> Youtu
    
    Ext -.->|"Context Injection"| CloudLLM

    %% 强制布局分层
    Clients ~~~ Backend
    Backend ~~~ Resources