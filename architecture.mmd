%%{init: {
  'theme': 'base',
  'themeVariables': {
    'background': '#FFF9F0',
    'mainBkg': '#FFF9F0',
    'primaryColor': '#D7CCC8',
    'primaryTextColor': '#3E2723',
    'primaryBorderColor': '#5D4037',
    'lineColor': '#795548',
    'secondaryColor': '#FFECB3',
    'tertiaryColor': '#FFF3E0',
    'noteBkgColor': '#FFFDE7',
    'noteTextColor': '#5D4037',
    'actorBkg': '#EFEBE9',
    'actorBorder': '#8D6E63',
    'actorTextColor': '#3E2723',
    'sequenceNumberColor': '#8D6E63'
  }
}}%%
sequenceDiagram
    autonumber
    
    box rgb(255, 248, 225) Sources
    actor User
    participant Client as Clients<br/>(Ext/MCP/File)
    end
    
    box rgb(252, 228, 236) Backend System
    participant Server as FastAPI Server
    participant Gate as Gatekeeper Agent
    end
    
    box rgb(255, 243, 224) External & Storage
    participant Gemini as Google Gemini
    participant Chroma as ChromaDB
    end

    Note over User, Chroma: Phase 1: Memory Ingestion (Save)

    User->>Client: Chat / Browse / Edit File
    Client->>Server: POST /memory (Raw Content)
    activate Server
    Server->>Gate: Delegate Processing
    activate Gate
    
    Gate->>Gemini: Analyze Intent & Clean Data
    activate Gemini
    Gemini-->>Gate: Structured Memory (JSON)
    deactivate Gemini
    
    alt is_valid_memory
        Gate->>Chroma: Save Vector & Metadata
        activate Chroma
        Chroma-->>Gate: Success
        deactivate Chroma
        Gate-->>Server: Saved (Memory ID)
    else is_noise
        Gate-->>Server: Ignored (Reason)
    end
    deactivate Gate

    Server-->>Client: Status Update (Green/Gray)
    deactivate Server

    Note over User, Chroma: Phase 2: Context Retrieval (RAG)

    User->>Client: Typing Query...
    Client->>Server: Search Memory (Query)
    activate Server
    Server->>Chroma: Query Embeddings (Top-K)
    activate Chroma
    Chroma-->>Server: Relevant Memories
    deactivate Chroma
    Server-->>Client: Context Injection
    deactivate Server
    Client-->>User: AI Response + Memory Context